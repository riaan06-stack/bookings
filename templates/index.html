<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INWMH Studios | Book Your Session</title>

  <style>
    /* ---------- Base / Reset ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg,#70a0af 0%,#706993 50%,#331e38 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
      color:#331e38;
    }
    .container{width:100%;max-width:1000px}

    header{text-align:center;margin-bottom:32px}
    header h1{color:#fff;font-size:2.6rem;font-weight:700;text-shadow:2px 2px 8px rgba(0,0,0,.3);letter-spacing:-0.5px}
    .subtitle{color:#f4e8c1;font-weight:300;margin-top:8px}

    .form-container{
      background:rgba(255,255,255,0.98);border-radius:18px;padding:34px;box-shadow:0 20px 60px rgba(0,0,0,.25);
    }

    /* ---------- Progress ---------- */
    .progress{display:flex;justify-content:space-between;margin-bottom:28px;position:relative}
    .progress::before{content:"";position:absolute;top:20px;left:0;right:0;height:3px;background:#e0e0e0;z-index:1}
    .step{flex:1;text-align:center;font-size:.85rem;color:#999;position:relative;z-index:2}
    .step::before{content:"";display:block;width:36px;height:36px;background:#e0e0e0;border-radius:50%;margin:0 auto 8px;border:4px solid #fff;transition:all .25s}
    .step.active{color:#706993;font-weight:600}
    .step.active::before{background:linear-gradient(135deg,#70a0af,#706993);transform:scale(1.1);box-shadow:0 4px 12px rgba(112,160,175,.45)}

    /* ---------- Form sections ---------- */
    .form-section{display:none;animation:slideIn .35s ease}
    .form-section.active{display:block}
    h2{font-size:1.6rem;margin-bottom:18px;color:#331e38;font-weight:600}
    input,select,textarea{width:100%;padding:12px 15px;margin-bottom:14px;border-radius:10px;border:2px solid #e0e0e0;background:#fafafa;font-size:1rem}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#70a0af;background:#fff;box-shadow:0 6px 18px rgba(112,160,175,.12);transform:translateY(-1px)}
    textarea{min-height:110px;resize:vertical}

    .button-row{display:flex;gap:12px;margin-top:8px}
    .prev{flex:1;background:#f5f5f5;color:#666;border:2px solid #e0e0e0;padding:12px 16px;border-radius:10px;cursor:pointer}
    .next,.submit-btn{flex:1;background:linear-gradient(135deg,#706993,#331e38);color:#fff;padding:12px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:600}
    .next:hover,.submit-btn:hover,.prev:hover{transform:translateY(-2px)}

    @keyframes slideIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}

    /* small extras used below */
    .setup-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:18px}
    .setup-card{border:2px solid #e0e0e0;border-radius:12px;padding:10px;text-align:center;background:#fafafa;cursor:pointer;transition:all .25s}
    .setup-card img{width:100%;border-radius:8px;margin-bottom:8px;display:block}
    .setup-card span{font-weight:600;color:#331e38}
    .setup-card input{display:none}
    .setup-card:hover{transform:translateY(-6px);border-color:#70a0af}
    .setup-card:has(input:checked){border-color:#706993;background:linear-gradient(135deg,#f8f7fa,#fff)}

    .package-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:16px}
    .package-card{position:relative;border:3px solid #e0e0e0;border-radius:18px;padding:22px;background:linear-gradient(135deg,#fff,#fafafa);cursor:pointer;transition:all .3s;display:flex;flex-direction:column;min-height:220px}
    .package-card input{display:none}
    .package-card:hover{transform:translateY(-8px);border-color:#706993;box-shadow:0 18px 40px rgba(112,105,147,.22)}
    .package-card:has(input:checked){background:linear-gradient(135deg,#d8ecf4,#edf8ff);border-color:#70a0af}
    .package-card h3{font-size:1.2rem;margin-bottom:6px;color:#331e38}
    .badge{position:absolute;top:-12px;left:18px;padding:8px 14px;border-radius:12px;font-weight:700;color:#fff}
    .badge.best{background:linear-gradient(135deg,#667eea,#764ba2)}
    .badge.exclusive{background:linear-gradient(135deg,#d4af37,#f4e8c1);color:#331e38}

    .people-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:12px}
    .person-icon{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#f0f0f0;cursor:pointer;position:relative;overflow:hidden;border:3px solid transparent;transition:all .3s}
    .person-icon span{position:relative;z-index:1;font-size:1.4rem;filter:grayscale(1)}
    .person-number{position:absolute;bottom:6px;right:6px;background:#fff;color:#706993;font-size:.7rem;font-weight:700;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(.6);transition:all .25s}
    .person-icon.active{background:linear-gradient(135deg,#70a0af,#706993);border-color:#706993}
    .person-icon.active span{filter:none;filter:brightness(1.3)}
    .person-icon.active .person-number{opacity:1;transform:scale(1)}

    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:10px}
    .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:linear-gradient(135deg,#fafafa,#f5f5f5);cursor:pointer;border:2px solid transparent;font-weight:700}
    .calendar-day:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(112,105,147,.12);border-color:rgba(112,105,147,.18)}
    .calendar-day.selected{background:linear-gradient(135deg,#706993,#5a5278);color:#fff;transform:translateY(-3px);box-shadow:0 8px 25px rgba(112,105,147,.28)}
    .calendar-day.past-date{background:#f0f0f0;color:#aaa;cursor:not-allowed;opacity:0.6}
    .calendar-day.past-date:hover{transform:none;box-shadow:none;border-color:transparent}

        .timeslot-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .timeslot{padding:12px;border-radius:10px;background:linear-gradient(135deg,#fafafa,#f8f7fa);border:2px solid rgba(112,105,147,.12);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .timeslot:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(112,105,147,.12)}
    .timeslot.selected{background:linear-gradient(135deg,#706993,#5a5278);color:#fff;border-color:#331e38;transform:translateY(-2px) scale(1.02)}
    
    /* NEW: booked/unavailable timeslots */
    .timeslot.booked{
      background:linear-gradient(135deg,#ff6b6b,#c62828);
      color:#fff;
      border-color:#c62828;
      cursor:not-allowed;
      opacity:.9;
      pointer-events:none;
    }

    /* NEW: blocked timeslots for multi-hour bookings */
    .timeslot.blocked {
        background: linear-gradient(135deg, #ffa726, #f57c00);
        color: #fff;
        border-color: #e65100;
        cursor: not-allowed;
        opacity: 0.8;
        pointer-events: none;
        position: relative;
        transform: none !important;
        box-shadow: none !important;
    }
    .timeslot.blocked::after {
        content: "Blocked";
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.65rem;
        font-weight: 600;
    }
    .timeslot.blocked:hover {
        transform: none !important;
        box-shadow: none !important;
        border-color: #e65100 !important;
    }

    .duration-selector {
      margin-top: 20px;
      padding: 15px;
      background: #f8f7fa;
      border-radius: 12px;
    }
    
    /* NEW: booked/unavailable timeslots */
    .timeslot.booked{
      background:linear-gradient(135deg,#ff6b6b,#c62828);
      color:#fff;
      border-color:#c62828;
      cursor:not-allowed;
      opacity:.9;
      pointer-events:none;
    }

    .duration-selector {
      margin-top: 20px;
      padding: 15px;
      background: #f8f7fa;
      border-radius: 12px;
    }
    .duration-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .duration-option {
      flex: 1;
      min-width: 80px;
      padding: 12px;
      border-radius: 10px;
      background: #f0f0f0;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .duration-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(112,105,147,.12);
    }
    .duration-option.selected {
      background: linear-gradient(135deg,#70a0af,#706993);
      color: white;
    }

    .success-message,.error-message{display:none;padding:14px;border-radius:10px;margin-top:14px;text-align:center;font-weight:600}
    .success-message{background:linear-gradient(135deg,#a0c1b9,#70a0af);color:#123; border:2px solid #70a0af}
    .error-message{background:linear-gradient(135deg,#ffebee,#ffcdd2);color:#c62828;border:2px solid #f44336}

    /* Popup */
    #thankYouPopup{display:none;position:fixed;inset:0;background:rgba(0,0,0,.56);backdrop-filter:blur(4px);z-index:9999;align-items:center;justify-content:center}
    #thankYouBox{background:#fff;padding:28px;border-radius:14px;max-width:420px;width:92%;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,.32)}
    #thankYouBox h2{margin-bottom:8px;color:#331e38}
    #thankYouBox p{color:#555;line-height:1.4}
    #thankYouBox button{margin-top:16px;padding:10px 20px;border-radius:10px;border:none;background:linear-gradient(135deg,#706993,#331e38);color:#fff;cursor:pointer;font-weight:700}

    @media (max-width:1024px){.package-grid{grid-template-columns:repeat(2,1fr)}.people-grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:768px){.package-grid{grid-template-columns:1fr}.people-grid{grid-template-columns:repeat(5,1fr)}header h1{font-size:1.9rem}}
    @media (max-width:480px){.people-grid{grid-template-columns:repeat(4,1fr)}.selected-number{font-size:2rem}}
  

  .admin-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4b7bec;
    color: #fff;
    padding: 12px 22px;
    border-radius: 12px;
    text-decoration: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0px 5px 15px rgba(0,0,0,0.18);
    transition: 0.25s ease-in-out;
    z-index: 2000;
}
.admin-btn:hover {
    background: #3867d6;
    transform: translateY(-3px);
}

  </style>
</head>

<body>

  <a href="/login" class="admin-btn">Admin Panel</a>

  <div class="container">
    <header>
      <h1>Reserve Your Studio Space</h1>
      <p class="subtitle">Book your professional recording session at INWMH Studios</p>
    </header>

    <div class="form-container">
      <div class="progress">
        <div class="step active">1. Personal</div>
        <div class="step">2. Setup</div>
        <div class="step">3. Package</div>
        <div class="step">4. Timing</div>
        <div class="step">5. Review</div>
      </div>

      <form id="reservationForm">
        <!-- SECTION 1 -->
        <div class="form-section active">
          <h2>Personal Details</h2>

          <input type="text" name="name" placeholder="Full Name" required>
          <input type="email" name="email" placeholder="Email" required>
          <input type="text" name="phone" placeholder="Phone" required>
          <input type="text" name="company" placeholder="Company (optional)">

          <div class="button-row">
            <div style="flex:1"></div>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- SECTION 2 -->
        <div class="form-section">
          <h2>Studio Setup</h2>

          <div class="setup-options">
            <label class="setup-card">
              <!-- NOTE: no required attribute here; validated at submit -->
              <input type="radio" name="setup" value="The Nexus Setup">
              <img src="/static/nexus.jpg" alt="Nexus Setup">
              <span>The Nexus Setup</span>
            </label>

            <label class="setup-card">
              <input type="radio" name="setup" value="The Duality Setup">
              <img src="/static/duality.jpg" alt="Duality Setup">
              <span>The Duality Setup</span>
            </label>

            <label class="setup-card">
              <input type="radio" name="setup" value="The Sync Setup">
              <img src="/static/sync.jpg" alt="Sync Setup">
              <span>The Sync Setup</span>
            </label>

            <label class="setup-card">
              <input type="radio" name="setup" value="The Halo Setup">
              <img src="/static/halo.jpg" alt="Halo Setup">
              <span>The Halo Setup</span>
            </label>
          </div>

          <label style="display:block;font-weight:700;margin-bottom:10px">How many people?</label>

          <div class="people-selector-container">
            <div class="selected-display">
              <div class="selected-number" id="displayNumber">1</div>
              <div class="selected-text" id="displayText">Person Selected</div>
            </div>

            <div class="people-grid" id="gridView"></div>

            <div class="controls">
              <button type="button" class="control-btn" id="decreaseBtn">‚àí</button>
              <div class="control-display" id="controlDisplay">1</div>
              <button type="button" class="control-btn" id="increaseBtn">+</button>
            </div>

            <!-- hidden input for people (no required in HTML) -->
            <input type="hidden" name="people" id="peopleInput" value="1">
          </div>

          <div class="button-row">
            <button type="button" class="prev">Previous</button>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- SECTION 3 -->
        <div class="form-section">
          <h2>Package Selection</h2>

          <div class="package-grid">
            <label class="package-card">
              <input type="radio" name="package" value="Recording + Live Mix">
              <h3>Recording + Live Mix</h3>
              <p class="package-subtitle">Ideal for immediate publishing in horizontal format.</p>
              <div class="price">$156.00 <span style="font-size:.8rem;color:#706993">/ per hour</span></div>
              <ul class="features">
                <li>‚úì Fully equipped Podcast Set of your choice</li>
                <li>‚úì Studio operator to record everything for you</li>
              </ul>
            </label>

            <label class="package-card">
              <div class="badge best">‚ö° Best Buy</div>
              <input type="radio" name="package" value="Recording + Professional Edit">
              <h3>Recording + Professional Edit</h3>
              <p class="package-subtitle">Perfect for a polished and professional finish.</p>
              <div class="old-price">$312.00</div>
              <div class="price">$276.00 <span style="font-size:.8rem;color:#706993">/ per hour</span></div>
              <div class="save">Save $36.00</div>
              <ul class="features">
                <li>‚úì Dedicated podcast producer to edit your episode</li>
              </ul>
            </label>

            <label class="package-card">
              <input type="radio" name="package" value="Recording">
              <h3>Recording</h3>
              <p class="package-subtitle">For raw footage you can edit later.</p>
              <div class="price">$120.00 <span style="font-size:.8rem;color:#706993">/ per hour</span></div>
              <ul class="features">
                <li>‚úì Raw footage backup for 14 days</li>
              </ul>
            </label>

            <label class="package-card">
              <input type="radio" name="package" value="Live Stream">
              <h3>Live Stream</h3>
              <p class="package-subtitle">Perfect for seamless and professional live streaming.</p>
              <div class="price">$138.00 <span style="font-size:.8rem;color:#706993">/ per hour</span></div>
              <ul class="features">
                <li>‚úì Live cutting with synced audio</li>
              </ul>
            </label>

            <label class="package-card">
              <input type="radio" name="package" value="Audio Only Recording">
              <h3>Audio Only Recording</h3>
              <p class="package-subtitle">Great for audio-only podcast production.</p>
              <div class="price">$108.00 <span style="font-size:.8rem;color:#706993">/ per hour</span></div>
              <ul class="features">
                <li>‚úì Multi-track recording</li>
              </ul>
            </label>

            <label class="package-card">
              <div class="badge exclusive">üî• Exclusive</div>
              <input type="radio" name="package" value="Exclusive Event Space">
              <h3>Exclusive Event Space</h3>
              <p class="package-subtitle">Live audience podcasting, workshops & more.</p>
              <div class="old-price">$480.00</div>
              <div class="price">$360.00 <span style="font-size:.8rem;color:#706993">/ per hour</span></div>
              <div class="save">Save $120.00</div>
              <ul class="features">
                <li>‚úì 4x Shure SM7B mics</li>
              </ul>
            </label>
          </div>

          <div class="button-row">
            <button type="button" class="prev">Previous</button>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- SECTION 4 -->
        <div class="form-section">
          <h2>Timing</h2>

          <div class="calendar-container">
            <div class="calendar-header" style="display:flex;align-items:center;gap:12px;margin-bottom:12px;border-bottom:2px solid #f5f3f7;padding-bottom:10px">
              <button id="prevMonth" class="cal-btn" style="padding:10px 14px;border-radius:10px;border:2px solid rgba(112,105,147,.09);background:linear-gradient(135deg,#f8f7fa,#f0eef4);cursor:pointer;font-weight:700;color:#706993;min-width:44px">&lt;</button>
              <div id="calendarMonth" style="flex:1;text-align:center;font-size:1.2rem;font-weight:700">Month</div>
              <button id="nextMonth" class="cal-btn" style="padding:10px 14px;border-radius:10px;border:2px solid rgba(112,105,147,.09);background:linear-gradient(135deg,#f8f7fa,#f0eef4);cursor:pointer;font-weight:700;color:#706993;min-width:44px">&gt;</button>
            </div>

            <div class="calendar-grid">
              <div class="day-label" style="text-align:center;font-weight:700;color:#706993;font-size:.78rem;text-transform:uppercase;padding:8px 0">Mon</div>
              <div class="day-label" style="text-align:center;font-weight:700;color:#706993;font-size:.78rem;text-transform:uppercase;padding:8px 0">Tue</div>
              <div class="day-label" style="text-align:center;font-weight:700;color:#706993;font-size:.78rem;text-transform:uppercase;padding:8px 0">Wed</div>
              <div class="day-label" style="text-align:center;font-weight:700;color:#706993;font-size:.78rem;text-transform:uppercase;padding:8px 0">Thu</div>
              <div class="day-label" style="text-align:center;font-weight:700;color:#706993;font-size:.78rem;text-transform:uppercase;padding:8px 0">Fri</div>
              <div class="day-label" style="text-align:center;font-weight:700;color:#706993;font-size:.78rem;text-transform:uppercase;padding:8px 0">Sat</div>
              <div class="day-label" style="text-align:center;font-weight:700;color:#706993;font-size:.78rem;text-transform:uppercase;padding:8px 0">Sun</div>
            </div>

            <div id="calendarDays" class="calendar-days-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px"></div>
          </div>

          <div class="timeslot-container" style="background:#fff;padding:18px;border-radius:12px;border:1px solid rgba(112,105,147,.07);margin-top:14px">
            <h3 id="selectedDateTitle" style="text-align:center;margin-bottom:12px">Select a date</h3>
            <div id="timeslotList" class="timeslot-list"></div>
          </div>

          <div class="duration-selector">
            <h3 style="margin-bottom:10px">Duration</h3>
            <p style="margin-bottom:10px;color:#666">How many hours would you like to book?</p>
            <div class="duration-options">
              <div class="duration-option" data-hours="2">2 hours</div>
              <div class="duration-option" data-hours="3">3 hours</div>
              <div class="duration-option" data-hours="4">4 hours</div>
              <div class="duration-option" data-hours="5">5 hours</div>
              <div class="duration-option" data-hours="6">6 hours</div>
              <div class="duration-option" data-hours="7">7 hours</div>
              <div class="duration-option" data-hours="8">8 hours</div>
              <div class="duration-option" data-hours="9">9 hours</div>
              <div class="duration-option" data-hours="10">10 hours</div>
            </div>
          </div>

          <!-- hidden fields (not required in HTML) -->
          <input type="hidden" name="date" id="selectedDateInput">
          <input type="hidden" name="time_slot" id="selectedTimeInput">
          <input type="hidden" name="duration" id="selectedDurationInput" value="2">

          <div class="button-row" style="margin-top:12px">
            <button type="button" class="prev">Previous</button>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- SECTION 5 -->
        <div class="form-section">
          <h2>Review & Submit</h2>

          <div id="reviewDetails" style="background:#f8f7fa;padding:20px;border-radius:12px;margin-bottom:20px">
            <h3 style="margin-bottom:15px;color:#331e38">Booking Summary</h3>
            <div id="reviewContent"></div>
          </div>

          <textarea name="requirements" placeholder="Special requests"></textarea>

          <select name="referral">
            <option value="">How did you hear about us?</option>
            <option>Friend</option>
            <option>Social Media</option>
            <option>Search Engine</option>
            <option>Other</option>
          </select>

          <div class="button-row" style="margin-bottom:14px">
            <button type="button" class="prev">Previous</button>
            <div style="flex:1"></div>
          </div>

          <button type="submit" class="submit-btn">Submit Booking</button>
        </div>
      </form>

      <div class="success-message" id="successMessage">‚úÖ Booking submitted successfully!</div>
      <div class="error-message" id="errorMessage">‚ùå Error submitting booking. Try again.</div>
    </div>
  </div>

  <!-- THANK YOU POPUP -->
  <div id="thankYouPopup">
    <div id="thankYouBox">
      <h2>Thank you! üéâ</h2>
      <p>Your booking has been submitted! Our team will connect with you shortly for confirmation.</p>
      <button onclick="closePopup()">Okay</button>
    </div>
  </div>

  <script>
    /* -----------------------
       Form Navigation & Utilities
    ------------------------*/
    const sections = document.querySelectorAll(".form-section");
    const steps = document.querySelectorAll(".step");
    const nextBtns = document.querySelectorAll(".next");
    const prevBtns = document.querySelectorAll(".prev");
    let current = 0;

    // REMOVED THE DISABLE FUNCTION - THIS WAS THE MAIN PROBLEM!
    function showSection(i) {
      current = i;
      sections.forEach((sec, idx) => sec.classList.toggle("active", idx === current));
      steps.forEach((st, idx) => st.classList.toggle("active", idx <= current));
      
      // Update review section when showing section 5
      if (i === 4) {
        updateReviewSection();
      }
    }

    nextBtns.forEach(btn => btn.addEventListener("click", () => {
      if (current < sections.length - 1) current++;
      showSection(current);
    }));

    prevBtns.forEach(btn => btn.addEventListener("click", () => {
      if (current > 0) current--;
      showSection(current);
    }));

    /* -----------------------
       People Selector
    ------------------------*/
    let selectedPeople = 1;
    const maxPeople = 10;
    const gridView = document.getElementById('gridView');
    const displayNumber = document.getElementById('displayNumber');
    const displayText = document.getElementById('displayText');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const controlDisplay = document.getElementById('controlDisplay');
    const peopleInput = document.getElementById('peopleInput');

    function initializeGrid() {
      gridView.innerHTML = '';
      for (let i = 1; i <= maxPeople; i++) {
        const personDiv = document.createElement('div');
        personDiv.className = 'person-icon';
        personDiv.dataset.number = i;

        const emoji = document.createElement('span');
        emoji.textContent = i === 1 ? 'üë§' : 'üë•';

        const badge = document.createElement('div');
        badge.className = 'person-number';
        badge.textContent = i;

        personDiv.appendChild(emoji);
        personDiv.appendChild(badge);

        personDiv.addEventListener('click', () => selectPeople(i));
        gridView.appendChild(personDiv);
      }
      updatePeople();
    }

    function selectPeople(num) {
      selectedPeople = num;
      updatePeople();
      animatePeople();
    }

    function updatePeople() {
      document.querySelectorAll('.person-icon').forEach((icon, idx) => {
        if (idx < selectedPeople) icon.classList.add('active'); else icon.classList.remove('active');
      });

      displayNumber.textContent = selectedPeople;
      displayText.textContent = selectedPeople === 1 ? 'Person Selected' : 'People Selected';
      controlDisplay.textContent = selectedPeople;
      peopleInput.value = selectedPeople;

      decreaseBtn.disabled = selectedPeople <= 1;
      increaseBtn.disabled = selectedPeople >= maxPeople;
    }

    function animatePeople() {
      displayNumber.style.transform = 'scale(1.2)';
      setTimeout(() => displayNumber.style.transform = 'scale(1)', 180);
    }

    decreaseBtn.onclick = () => { if (selectedPeople > 1) selectPeople(selectedPeople - 1); };
    increaseBtn.onclick = () => { if (selectedPeople < maxPeople) selectPeople(selectedPeople + 1); };

    initializeGrid();

    /* -----------------------
       Calendar & Timeslots
    ------------------------*/
    const calendarDays = document.getElementById("calendarDays");
    const calendarMonth = document.getElementById("calendarMonth");
    const selectedDateInput = document.getElementById("selectedDateInput");
    const selectedTimeInput = document.getElementById("selectedTimeInput");
    const selectedDateTitle = document.getElementById("selectedDateTitle");
    const timeslotList = document.getElementById("timeslotList");

    let currentDate = new Date();
    let bookedSlotsForSelectedDate = []; // NEW: list of booked times for current date

    const timeslots = [
      "9:00 AM","9:30 AM","10:00 AM","10:30 AM","11:00 AM","11:30 AM",
      "12:00 PM","12:30 PM","1:00 PM","1:30 PM",
      "2:00 PM","2:30 PM","3:00 PM","3:30 PM","4:00 PM","4:30 PM",
      "5:00 PM","5:30 PM","6:00 PM"
    ];

    function loadCalendar() {
      calendarDays.innerHTML = "";
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      calendarMonth.textContent = currentDate.toLocaleString("default", { month: "long", year: "numeric" });

      const firstDayIndex = new Date(year, month, 1).getDay(); // 0 (Sun) .. 6
      const firstDay = firstDayIndex === 0 ? 7 : firstDayIndex; // Monday-first shift

      for (let i = 1; i < firstDay; i++) {
        calendarDays.appendChild(document.createElement("div"));
      }

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time for accurate comparison
      
      for (let d = 1; d <= daysInMonth; d++) {
        const el = document.createElement("div");
        const dateObj = new Date(year, month, d);
        dateObj.setHours(0, 0, 0, 0);
        
        el.className = "calendar-day";
        el.textContent = d;
        
        // Check if date is in the past
        if (dateObj < today) {
          el.classList.add("past-date");
        } else {
          el.onclick = () => selectDate(year, month, d, el);
        }
        
        calendarDays.appendChild(el);
      }
    }

    function selectDate(year, month, day, element) {
      document.querySelectorAll(".calendar-day").forEach(e => e.classList.remove("selected"));
      element.classList.add("selected");

      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      selectedDateInput.value = dateStr;

      const formatted = new Date(year, month, day).toLocaleDateString("default", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
      selectedDateTitle.textContent = `Available times for ${formatted}`;

      // NEW: fetch booked slots + off-day info from backend
      fetch(`/booked_slots?date=${encodeURIComponent(dateStr)}`)
        .then(res => res.json())
        .then(data => {
          bookedSlotsForSelectedDate = data.booked || [];
          if (data.off_day) {
            timeslotList.innerHTML = "<div style='padding:12px;text-align:center;font-weight:600;color:#c62828;'>Studio is closed on this date.</div>";
            selectedTimeInput.value = "";
          } else {
            loadTimeslots();
          }
        })
        .catch(err => {
          console.error("Error fetching booked slots:", err);
          bookedSlotsForSelectedDate = [];
          loadTimeslots();
        });
    }

    function loadTimeslots() {
      timeslotList.innerHTML = "";
      selectedTimeInput.value = "";

      timeslots.forEach(time => {
        const t = document.createElement("div");
        t.className = "timeslot";
        t.textContent = time;

        // If this time is booked for the selected date -> mark as booked & disable click
        if (bookedSlotsForSelectedDate.includes(time)) {
          t.classList.add("booked");
        } else {
          t.onclick = () => {
            document.querySelectorAll(".timeslot").forEach(el => el.classList.remove("selected"));
            t.classList.add("selected");
            selectedTimeInput.value = time;
          };
        }

        timeslotList.appendChild(t);
      });
    }

    document.getElementById("prevMonth").onclick = () => { 
      currentDate.setMonth(currentDate.getMonth() - 1); 
      loadCalendar(); 
    };
    
    document.getElementById("nextMonth").onclick = () => { 
      currentDate.setMonth(currentDate.getMonth() + 1); 
      loadCalendar(); 
    };

    loadCalendar();

    /* -----------------------
       Duration Selector
    ------------------------*/
    const durationOptions = document.querySelectorAll('.duration-option');
    const selectedDurationInput = document.getElementById('selectedDurationInput');

    durationOptions.forEach(option => {
      option.addEventListener('click', () => {
        durationOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedDurationInput.value = option.dataset.hours;
      });
    });

    // Set default duration
    durationOptions[0].classList.add('selected');

    /* -----------------------
       Review Section
    ------------------------*/
    function updateReviewSection() {
      const formData = new FormData(document.getElementById('reservationForm'));
      const reviewContent = document.getElementById('reviewContent');
      
      // Get values directly from form elements to ensure we have the actual data
      const name = document.querySelector('input[name="name"]')?.value || 'Not provided';
      const email = document.querySelector('input[name="email"]')?.value || 'Not provided';
      const phone = document.querySelector('input[name="phone"]')?.value || 'Not provided';
      const company = document.querySelector('input[name="company"]')?.value || 'Not provided';
      const setup = document.querySelector('input[name="setup"]:checked')?.value || 'Not selected';
      const people = document.querySelector('input[name="people"]')?.value || '1';
      const package = document.querySelector('input[name="package"]:checked')?.value || 'Not selected';
      const date = document.querySelector('input[name="date"]')?.value || 'Not selected';
      const time = document.querySelector('input[name="time_slot"]')?.value || 'Not selected';
      const duration = document.querySelector('input[name="duration"]')?.value || '2';
      const requirements = document.querySelector('textarea[name="requirements"]')?.value || 'None';
      const referral = document.querySelector('select[name="referral"]')?.value || 'Not specified';
      
      reviewContent.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div><strong>Name:</strong></div><div>${name}</div>
          <div><strong>Email:</strong></div><div>${email}</div>
          <div><strong>Phone:</strong></div><div>${phone}</div>
          <div><strong>Company:</strong></div><div>${company}</div>
          <div><strong>Setup:</strong></div><div>${setup}</div>
          <div><strong>People:</strong></div><div>${people}</div>
          <div><strong>Package:</strong></div><div>${package}</div>
          <div><strong>Date:</strong></div><div>${date}</div>
          <div><strong>Time:</strong></div><div>${time}</div>
          <div><strong>Duration:</strong></div><div>${duration} hours</div>
          <div><strong>Special Requests:</strong></div><div>${requirements}</div>
          <div><strong>Referral:</strong></div><div>${referral}</div>
        </div>
      `;
    }
    
    /* -----------------------
       Submit validation + send
    ------------------------*/
    const form = document.getElementById("reservationForm");
    const successMessage = document.getElementById("successMessage");
    const errorMessage = document.getElementById("errorMessage");

    function validateBeforeSubmit(data) {
      // data is a plain object from FormData
      if (!data.name || !data.email || !data.phone) {
        alert("Please fill in all required personal details (Name, Email, Phone).");
        showSection(0); // navigate user to Personal section
        return false;
      }
      if (!data.setup) {
        alert("Please select a studio setup before submitting.");
        showSection(1); // navigate user to Setup
        return false;
      }
      if (!data.package) {
        alert("Please select a package before submitting.");
        showSection(2); // go to Package
        return false;
      }
      // people should be > 0
      const peopleNum = Number(data.people || 0);
      if (!peopleNum || peopleNum < 1) {
        alert("Please choose how many people will attend the session.");
        showSection(1); // people selector is in Setup section
        return false;
      }
      if (!data.date) {
        alert("Please select a date for your booking.");
        showSection(3); // Timing section
        return false;
      }
      if (!data.time_slot) {
        alert("Please select a time slot for your booking.");
        showSection(3); // Timing section
        return false;
      }
      // all good
      return true;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      successMessage.style.display = "none";
      errorMessage.style.display = "none";

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // DEBUG: Log all form data before sending
      console.log("üìã ALL FORM DATA BEFORE SUBMIT:");
      for (let key in data) {
        console.log(`   ${key}: ${data[key]}`);
      }

      // Validate required fields before sending
      if (!validateBeforeSubmit(data)) return;

      try {
        const res = await fetch("/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          successMessage.style.display = "block";
          showPopup();
          form.reset();
          // reset UI state
          current = 0;
          showSection(0);
          selectedPeople = 1;
          initializeGrid();
          selectedDateInput.value = "";
          selectedTimeInput.value = "";
          document.querySelectorAll(".calendar-day").forEach(el => el.classList.remove("selected"));
          document.querySelectorAll(".timeslot").forEach(el => el.classList.remove("selected"));
          selectedDateTitle.textContent = "Select a date";
          timeslotList.innerHTML = "";
          // Reset duration
          durationOptions.forEach(opt => opt.classList.remove('selected'));
          durationOptions[0].classList.add('selected');
          selectedDurationInput.value = "2";
        } else {
          errorMessage.style.display = "block";
          const txt = await res.text();
          console.error("Server returned non-200:", res.status, txt);
        }
      } catch (err) {
        console.error(err);
        errorMessage.style.display = "block";
      }
    });
        /* -----------------------
       Time Slot Validation for Multi-hour Duration
    ------------------------*/
    function getTimeSlotsInDuration(startTime, durationHours) {
        const timeSlots = [
            "9:00 AM", "9:30 AM", "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM",
            "12:00 PM", "12:30 PM", "1:00 PM", "1:30 PM", 
            "2:00 PM", "2:30 PM", "3:00 PM", "3:30 PM", "4:00 PM", "4:30 PM",
            "5:00 PM", "5:30 PM", "6:00 PM"
        ];
        
        const startIndex = timeSlots.indexOf(startTime);
        if (startIndex === -1) return [];
        
        // Calculate all time slots needed for this duration
        const totalSlotsNeeded = durationHours * 2;
        const requiredSlots = [];
        
        for (let i = 0; i < totalSlotsNeeded; i++) {
            if (startIndex + i < timeSlots.length) {
                requiredSlots.push(timeSlots[startIndex + i]);
            }
        }
        
        return requiredSlots;
    }

    // Update the timeslot click handler to validate against existing bookings
    function setupTimeslotClickHandlers() {
        document.querySelectorAll('.timeslot:not(.booked)').forEach(timeslot => {
            timeslot.onclick = function() {
                const selectedTime = this.textContent;
                const duration = parseInt(selectedDurationInput.value);
                
                // Check if any of the required time slots are already booked
                const requiredSlots = getTimeSlotsInDuration(selectedTime, duration);
                const hasConflict = requiredSlots.some(slot => 
                    bookedSlotsForSelectedDate.includes(slot)
                );
                
                if (hasConflict) {
                    alert(`This time slot is not available for ${duration}-hour booking. Some of the required time slots are already booked.`);
                    return;
                }
                
                document.querySelectorAll(".timeslot").forEach(el => el.classList.remove("selected"));
                this.classList.add("selected");
                selectedTimeInput.value = selectedTime;
            };
        });
    }

    // Override the original loadTimeslots function to include our validation
    const originalLoadTimeslots = loadTimeslots;
    loadTimeslots = function() {
        originalLoadTimeslots();
        setTimeout(setupTimeslotClickHandlers, 100);
    };

    // Also call setup when calendar date is selected
    const originalSelectDate = selectDate;
    selectDate = function(year, month, day, element) {
        originalSelectDate(year, month, day, element);
        setTimeout(setupTimeslotClickHandlers, 500);
    };

    /* -----------------------
       Popup
    ------------------------*/
    function showPopup() {
      document.getElementById("thankYouPopup").style.display = "flex";
    }
    function closePopup() {
      document.getElementById("thankYouPopup").style.display = "none";
    }
  </script>
</body>
</html>
